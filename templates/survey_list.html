{% extends "base.html" %}

{% block title %}Anketler | Bulut TabanlÄ± Anket Sistemi{% endblock %}

{% block content %}
<div class="main-card">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="page-title mb-1">Mevcut Anketler</h2>
      <p class="page-subtitle mb-0">Anketleri yÃ¶net, linkini paylaÅŸ, sonuÃ§larÄ± incele.</p>
    </div>

    <!-- SAÄ BUTON GRUBU -->
    <div class="d-flex align-items-center" style="gap:10px;">
      <a href="{{ url_for('create_survey') }}" class="btn btn-primary rounded-pill px-4">
        + Anket OluÅŸtur
      </a>
      <a href="{{ url_for('analytics') }}" class="btn btn-outline-secondary rounded-pill px-4">
        Ä°statistikler
      </a>
    </div>
  </div>

    <!-- Stats -->
  <div class="dash-stats mb-4">
    <div class="dash-stat">
      <div class="dash-stat-label">Toplam Anket</div>
      <div class="dash-stat-value">
        {{ surveys|length if surveys else 0 }}
      </div>
    </div>

    <div class="dash-stat">
      <div class="dash-stat-label">Toplam Soru</div>
      <div class="dash-stat-value">
        {{ total_questions }}
      </div>
    </div>

    <div class="dash-stat">
      <div class="dash-stat-label">Toplam KatÄ±lÄ±mcÄ±</div>
      <div class="dash-stat-value">
        {{ total_responses }}
      </div>
    </div>
  </div>


  <!-- Toolbar -->
  <div class="dash-toolbar mb-3">
    <div class="dash-search">
      <input id="surveySearch" type="text" class="form-control" placeholder="Anket ara (baÅŸlÄ±k / aÃ§Ä±klama)â€¦">
    </div>

    <div class="dash-actions">
      <select id="surveySort" class="form-control dash-select">
        <option value="newest" selected>Yeni â†’ Eski</option>
        <option value="oldest">Eski â†’ Yeni</option>
        <option value="responses_desc">KatÄ±lÄ±mcÄ± Ã§ok â†’ az</option>
        <option value="questions_desc">Soru Ã§ok â†’ az</option>
        <option value="title_asc">BaÅŸlÄ±k A â†’ Z</option>
      </select>
    </div>
  </div>

  <br>

  {% if surveys %}
    <div id="surveyGrid" class="survey-grid">
      {% for s in surveys %}
        {% set qc = (s.question_count or 0) %}
        {% set rc = (s.response_count or 0) %}

        <div class="card card-survey survey-item"
             data-title="{{ (s.title or '')|lower }}"
             data-desc="{{ (s.description or '')|lower }}"
             data-created="{{ s.created_at }}"
             data-qc="{{ qc }}"
             data-rc="{{ rc }}">

          <div class="card-body survey-card-body">
            <!-- Top row -->
            <div class="survey-top">
              <div class="survey-title-wrap">
                <h5 class="survey-title mb-1">{{ s.title }}</h5>

                <div class="survey-badges">
                  {% if qc == 0 %}
                    <span class="badge badge-soft badge-draft">Taslak</span>
                  {% else %}
                    <span class="badge badge-soft badge-live">YayÄ±nda</span>
                  {% endif %}
                  {% if rc > 0 %}
                    <span class="badge badge-soft badge-hasresp">YanÄ±t var</span>
                  {% endif %}
                </div>
              </div>

              <!-- Actions -->
              <div class="survey-actions">
                <a href="{{ url_for('manage_questions', survey_id=s.id) }}"
                   class="btn btn-sm btn-primary rounded-pill">
                  SorularÄ± YÃ¶net
                </a>

                <a href="{{ url_for('edit_survey', survey_id=s.id) }}"
                   class="btn btn-sm btn-outline-dark rounded-pill ml-1">
                  DÃ¼zenle
                </a>

                <div class="survey-more ml-1">
                  <button type="button" class="more-btn" aria-label="Daha fazla">â‹¯</button>

                  <div class="more-menu">
                    <button type="button"
                            class="more-item copy-link-btn"
                            data-link="{{ request.host_url }}surveys/{{ s.id }}/take">
                      Anket Linki
                    </button>

                    <a class="more-item" href="{{ url_for('take_survey', survey_id=s.id) }}">
                      Anketi Doldur
                    </a>

                    <div class="more-divider"></div>

                    <form action="{{ url_for('delete_survey', survey_id=s.id) }}"
                          method="post"
                          onsubmit="return confirm('Bu anketi silmek istediÄŸine emin misin?');">
                      <button type="submit" class="more-item danger">Sil</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            <!-- Description -->
            {% if s.description %}
              <div class="survey-desc">
                {{ s.description }}
              </div>
            {% endif %}

            <!-- Meta -->
            <div class="survey-meta">
              <div class="meta-pill">ğŸ§¾ {{ qc }} soru</div>
              <div class="meta-pill">ğŸ‘¤ {{ rc }} katÄ±lÄ±mcÄ±</div>
              <div class="meta-pill">ğŸ“… {{ s.created_date or '-' }}</div>
              <div class="meta-pill">â±ï¸ {% if s.avg_duration_min is not none %}{{ s.avg_duration_min }} dk ort. sÃ¼re{% else %}-{% endif %}</div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <div id="noResults" class="text-center py-5" style="display:none;">
      <p class="mb-2">Aramana uygun anket bulunamadÄ±.</p>
    </div>

  {% else %}
    <div class="text-center py-5">
      <p class="mb-2">HenÃ¼z hiÃ§ anket oluÅŸturulmamÄ±ÅŸ.</p>
      <a href="{{ url_for('create_survey') }}" class="btn btn-primary rounded-pill">
        Ä°lk anketi oluÅŸtur
      </a>
    </div>
  {% endif %}
</div>

<div id="toast" class="toast">Link kopyalandÄ± âœ…</div>

<script>
(function () {
  // --- More menu toggle ---
  document.addEventListener("click", function (e) {
    const more = e.target.closest(".survey-more");
    document.querySelectorAll(".survey-more.open").forEach(x => {
      if (!more || x !== more) x.classList.remove("open");
    });
    if (more && e.target.closest(".more-btn")) {
      more.classList.toggle("open");
    }
    if (!more) {
      document.querySelectorAll(".survey-more.open").forEach(x => x.classList.remove("open"));
    }
  });

  // --- Search + sort (client-side) ---
  const searchEl = document.getElementById("surveySearch");
  const sortEl = document.getElementById("surveySort");
  const grid = document.getElementById("surveyGrid");
  const noResults = document.getElementById("noResults");

  if (!grid) return;

  function getItems() {
    return Array.from(grid.querySelectorAll(".survey-item"));
  }

  function applyFilter() {
    const q = (searchEl.value || "").trim().toLowerCase();
    let visible = 0;

    getItems().forEach(item => {
      const t = item.dataset.title || "";
      const d = item.dataset.desc || "";
      const ok = !q || t.includes(q) || d.includes(q);
      item.style.display = ok ? "" : "none";
      if (ok) visible++;
    });

    if (noResults) noResults.style.display = visible === 0 ? "" : "none";
  }

  function applySort() {
    const mode = sortEl.value;
    const items = getItems();

    items.sort((a, b) => {
      const aCreated = a.dataset.created || "";
      const bCreated = b.dataset.created || "";
      const aQC = parseInt(a.dataset.qc || "0", 10);
      const bQC = parseInt(b.dataset.qc || "0", 10);
      const aRC = parseInt(a.dataset.rc || "0", 10);
      const bRC = parseInt(b.dataset.rc || "0", 10);
      const aTitle = a.dataset.title || "";
      const bTitle = b.dataset.title || "";

      if (mode === "newest") return (bCreated > aCreated) ? 1 : -1;
      if (mode === "oldest") return (aCreated > bCreated) ? 1 : -1;
      if (mode === "responses_desc") return bRC - aRC;
      if (mode === "questions_desc") return bQC - aQC;
      if (mode === "title_asc") return aTitle.localeCompare(bTitle, "tr");
      return 0;
    });

    items.forEach(it => grid.appendChild(it));
  }

  if (searchEl) searchEl.addEventListener("input", applyFilter);
  if (sortEl) sortEl.addEventListener("change", function () {
    applySort();
    applyFilter();
  });

  applySort();
  applyFilter();
})();
</script>

<script>
document.addEventListener("click", async function(e){
  const btn = e.target.closest(".copy-link-btn");
  if (!btn) return;

  const link = btn.dataset.link;
  if (!link) return;

  const toast = document.getElementById("toast");

  try{
    await navigator.clipboard.writeText(link);
  }catch(err){
    // fallback
    const ta = document.createElement("textarea");
    ta.value = link;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
  }

  toast.classList.add("show");

  setTimeout(() => {
    toast.classList.remove("show");
  }, 1200);
});
</script>

{% endblock %}
