{% extends "base.html" %}
{% block title %}Anket Sonuçları{% endblock %}

{% block content %}
<style>
  .highlight-green {
    border: 2px solid #16a34a !important;
    background: rgba(22,163,74,.08) !important;
  }
  .highlight-green .progress-bar { background-color: #16a34a !important; }
</style>

<div class="main-card">
  <h2 class="page-title mb-1">"{{ survey.title }}" Anket Sonuçları</h2>
  <p class="page-subtitle mb-4">{{ survey.description }}</p>

  <!-- Katılımcı seçimi -->
  <div class="card card-result mb-3">
    <div class="card-body">
      <div class="section-title mb-2">Katılımcı Bazlı Görünüm</div>

      <form method="get" class="form-row align-items-end">
        <div class="form-group col-md-8 mb-2">
          <label>Katılımcı seç</label>
          <select name="participant_id" class="form-control" onchange="this.form.submit()">
            <option value="">(Seçilmezse: sadece toplam sonuç)</option>

            {% for p in participants %}
              {% set fn = (p.first_name or '').strip() %}
              {% set ln = (p.last_name or '').strip() %}
              {% set ln_initial = (ln[:1] ~ '.') if ln|length > 0 else '' %}
              {% set label = (fn ~ ' ' ~ ln_initial).strip() %}
              {% if not label %}
                {% set label = 'Katılımcı' %}
              {% endif %}

              <option value="{{ p.id }}"
                {% if selected_participant and p.id == selected_participant.id %}selected{% endif %}>
                Katılımcı #{{ loop.index }} – {{ label }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group col-md-4 mb-2">
          <button class="btn btn-primary rounded-pill w-100" type="submit">Uygula</button>
        </div>
      </form>

      {% if selected_participant %}
        <div class="text-muted-sm">
          Seçili: <strong>{{ selected_participant.first_name }} {{ selected_participant.last_name }}</strong> ({{ selected_participant.email }})
        </div>
      {% endif %}
    </div>
  </div>

  {% for q in questions %}
    <div class="card card-result mb-3">
      <div class="card-body">
        <div class="question-header d-flex align-items-center mb-2">
          <span class="question-number">{{ loop.index }}</span>
          <div class="ml-2">
            <strong>{{ q.question_text }}</strong>
            <div class="text-muted-sm mt-1">
              {% if q.question_type == "single_choice" %}Tek seçim
              {% elif q.question_type == "multiple_choice" %}Çok seçim
              {% elif q.question_type == "text" %}Açık uçlu
              {% elif q.question_type == "rating" %}Ölçek
              {% endif %}
            </div>
          </div>
        </div>

        {% if q.question_type in ["single_choice","multiple_choice"] %}
          <div class="mb-2">
            <span class="badge badge-pill vote-badge">{{ q.total_votes }} işaretleme</span>
          </div>

          {% set selected_ids = (participant_answers_map["choice"].get(q.id) if selected_participant else none) %}
          {% for o in q.options_stats %}
            {% set is_sel = (selected_ids is not none and (o.id in selected_ids)) %}
            <div class="mt-2 {% if is_sel %}highlight-green{% endif %}" style="padding:10px; border-radius:12px;">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <span class="option-letter">{{ ('abcdefghijklmnopqrstuvwxyz')[loop.index0] }}</span>
                  <span class="ml-2">{{ o.option_text }}</span>
                </div>
                <span class="text-muted-sm">{{ o.vote_count }} ({{ o.percent }}%)</span>
              </div>
              <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: {{ o.percent }}%;"></div>
              </div>
            </div>
          {% endfor %}

          {% if q.other_texts and q.other_texts|length > 0 %}
            <hr>
            <div class="section-title">Metin cevaplar (son 20)</div>
            <ul class="mb-0">
              {% for t in q.other_texts %}
                {% set is_sel_text = (selected_participant and participant_answers_map["text"].get(q.id) == t) %}
                <li {% if is_sel_text %}class="highlight-green"{% endif %} style="padding:8px; border-radius:10px; margin-bottom:6px;">
                  {{ t }}
                </li>
              {% endfor %}
            </ul>
          {% endif %}

        {% elif q.question_type == "rating" %}
          <div class="mt-2">
            <span class="badge badge-pill vote-badge">{{ q.rating_count }} yanıt</span>
            <div class="text-muted-sm mt-2">
              Ortalama:
              {% if q.rating_avg is not none %} {{ q.rating_avg }} {% else %} - {% endif %}
            </div>

            {% set sel_rating = (participant_answers_map["rating"].get(q.id) if selected_participant else none) %}
            <div class="mt-3">
              {% for r in q.rating_distribution %}
                <div class="d-flex justify-content-between align-items-center mt-2 {% if sel_rating is not none and r.rating == sel_rating %}highlight-green{% endif %}"
                     style="padding:8px 10px; border-radius:12px;">
                  <div><strong>{{ r.rating }}</strong></div>
                  <div class="text-muted-sm">{{ r.cnt }}</div>
                </div>
              {% endfor %}
            </div>
          </div>

        {% else %} {# text #}
          <div class="mt-2">
            <span class="badge badge-pill vote-badge">{{ q.text_count }} yanıt</span>
          </div>

          {% if q.text_answers and q.text_answers|length > 0 %}
            <hr>
            <div class="section-title">Son cevaplar</div>
            <ul class="mb-0">
              {% for t in q.text_answers %}
                {% set is_sel_text = (selected_participant and participant_answers_map["text"].get(q.id) == t) %}
                <li {% if is_sel_text %}class="highlight-green"{% endif %} style="padding:8px; border-radius:10px; margin-bottom:6px;">
                  {{ t }}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-muted-sm mt-2">Henüz cevap yok.</div>
          {% endif %}
        {% endif %}
      </div>
    </div>
  {% endfor %}

  <a href="{{ url_for('list_surveys') }}" class="btn btn-light rounded-pill mt-2">
    Anket Listesine Dön
  </a>
</div>
{% endblock %}
