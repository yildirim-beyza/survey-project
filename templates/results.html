{% extends "base.html" %}
{% block title %}Anket Sonuçları{% endblock %}

{% block content %}
<div class="main-card">
    <h2 class="page-title mb-1">"{{ survey.title }}" Anket Sonuçları</h2>
    <p class="page-subtitle mb-4">{{ survey.description }}</p>

    {% for q in questions %}
        <div class="card card-result mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <div class="question-header d-flex align-items-center mb-2">
                            <span class="question-number">{{ loop.index }}</span>
                            <strong class="ml-2">{{ q.question_text }}</strong>
                        </div>
                    </div>
                    <span class="badge badge-pill vote-badge">
                        {{ q.total_votes }} oy
                    </span>
                </div>
                <div class="row mt-2">

                    <!-- Sol taraf: bar grafikleri -->
<div class="col-md-7">
    {% for o in q.options %}
        <div class="mt-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span class="option-letter">
                        {{ ('abcdefghijklmnopqrstuvwxyz')[loop.index0] }}
                    </span>
                    <span class="ml-2">{{ o.option_text }}</span>
                </div>
                <span class="text-muted-sm">
                    {{ o.vote_count }} oy ({{ o.percent }}%)
                </span>
            </div>
            <div class="progress">
                <div class="progress-bar"
                     role="progressbar"
                     style="width: {{ o.percent }}%;"
                     aria-valuenow="{{ o.percent }}"
                     aria-valuemin="0"
                     aria-valuemax="100">
                </div>
            </div>
        </div>
    {% endfor %}
</div>

                    <!-- Sağ taraf: pasta grafik -->
<div class="col-md-5">
    <div class="pie-wrapper d-flex align-items-center justify-content-center">
        <div class="pie-holder d-flex align-items-center">
            <canvas id="pieChart_{{ q.id }}" class="pie-canvas"></canvas>
            <ul class="pie-legend">
                {% for o in q.options %}
                    <li>
                        <span class="color-box"></span>
                        <span>{{ o.option_text }}</span>
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>


                </div>
            </div>
        </div>
    {% endfor %}

    <a href="{{ url_for('list_surveys') }}" class="btn btn-light rounded-pill mt-2">
        Anket Listesine Dön
    </a>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    {% for q in questions %}
    (function () {
        var ctx = document.getElementById("pieChart_{{ q.id }}").getContext("2d");

        // Etiketler ve oy sayıları
        var labels = [
            {% for o in q.options %}"{{ o.option_text }}",{% endfor %}
        ];
        var data = [
            {% for o in q.options %}{{ o.vote_count }},{% endfor %}
        ];

        // En az bir oy var mı?
        var hasVotes = data.some(function (v) { return v > 0; });

        // Renk paleti (maks 6 şık için)
        var baseColors = [
            "#4f46e5",
            "#06b6d4",
            "#10b981",
            "#fbbf24",
            "#ef4444",
            "#8b5cf6"
        ];

        var chartConfig = {
            type: "pie",
            data: {
                // Oy varsa normal etiketler, yoksa tek dummy etiket
                labels: hasVotes ? labels : ["Henüz oy yok"],
                datasets: [{
                    // Oy varsa gerçek data, yoksa tek dilimlik placeholder
                    data: hasVotes ? data : [1],
                    backgroundColor: hasVotes
                        ? baseColors.slice(0, data.length)
                        : ["#e5e7eb"]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false   // HTML legend'i kullanıyoruz
                    },
                    tooltip: {
                        enabled: hasVotes // Oy yoksa tooltip de çıkmasın
                    }
                }
            }
        };

        new Chart(ctx, chartConfig);
    })();
    {% endfor %}

});
</script>

{% endblock %}
