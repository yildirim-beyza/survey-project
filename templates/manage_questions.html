{% extends "base.html" %}
{% block title %}Anket Soruları{% endblock %}

{% block content %}
<div class="main-card">
  <h2 class="page-title mb-1">"{{ survey.title }}" Anketi</h2>
  <p class="page-subtitle mb-4">
    Bu anket için farklı soru tipleri ekleyebilirsiniz: tek seçim, çok seçim, açık uçlu, ölçek vb.
  </p>

  <!-- Yeni soru ekleme formu -->
  <h5 class="mb-3">Yeni Soru Ekle</h5>

  <div class="form-card">
    <form method="post" id="questionForm" class="mb-2">
      <div class="form-group">
        <label>Soru Metni</label>
        <input type="text" name="question_text" class="form-control" required>
      </div>

      <div class="form-row">
        <!-- Soru tipi -->
        <div class="form-group col-md-6">
          <label>Soru Tipi</label>
          <select name="question_type" id="questionType" class="form-control">
            <option value="single_choice" selected>Tek Seçim (Radio)</option>
            <option value="multiple_choice">Çok Seçim (Checkbox)</option>
            <option value="text">Açık Uçlu (Metin)</option>
            <option value="rating">Değerlendirme Ölçeği (Likert/Rating)</option>
          </select>
        </div>

        <!-- Zorunlu mu -->
        <div class="form-group col-md-6">
          <label>Zorunlu mu?</label>
          <select name="is_required" class="form-control">
            <option value="1" selected>Evet</option>
            <option value="0">Hayır</option>
          </select>
        </div>
      </div>

      <!-- Seçenekli sorular alanı (single/multiple) -->
      <div id="optionsSection" class="mt-2">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="section-title mb-0">Şıklar</div>
            <div class="text-muted-sm">En az 2 şık önerilir. “+ Şık ekle” ile çoğalt.</div>
          </div>
          <button type="button" class="btn btn-sm btn-outline-dark rounded-pill" id="addOptionBtn">
            + Şık ekle
          </button>
        </div>

        <div id="optionsList"></div>

        <small class="text-muted-sm d-block mt-2">
          Not: Boş bırakılan şıklar kaydedilmez.
        </small>
      </div>

      <!-- Açık uçlu sorular ayarları -->
      <div id="textSection" class="mt-3" style="display:none;">
        <div class="section-title">Açık Uçlu Ayarlar</div>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label>Placeholder (isteğe bağlı)</label>
            <input type="text" name="text_placeholder" class="form-control" placeholder="Yanıtınızı yazın...">
          </div>
          <div class="form-group col-md-6">
            <label>Maksimum karakter (isteğe bağlı)</label>
            <input type="number" name="text_maxlen" class="form-control" min="10" step="10" placeholder="Örn: 250">
          </div>
        </div>
      </div>

      <!-- Ölçek soruları ayarları -->
      <div id="ratingSection" class="mt-3" style="display:none;">
        <div class="section-title">Ölçek Ayarları</div>
        <div class="form-row">
          <div class="form-group col-md-3">
            <label>Min</label>
            <input type="number" name="scale_min" class="form-control" value="1" min="1" max="10">
          </div>
          <div class="form-group col-md-3">
            <label>Max</label>
            <input type="number" name="scale_max" class="form-control" value="5" min="1" max="10">
          </div>
          <div class="form-group col-md-3">
            <label>Min Etiket (ops.)</label>
            <input type="text" name="scale_min_label" class="form-control" placeholder="Örn: Çok kötü">
          </div>
          <div class="form-group col-md-3">
            <label>Max Etiket (ops.)</label>
            <input type="text" name="scale_max_label" class="form-control" placeholder="Örn: Mükemmel">
          </div>
        </div>
        <small class="text-muted-sm">Likert gibi düşünebilirsin: 1-5 / 1-7 vs.</small>
      </div>

      <!-- Aksiyon butonları -->
      <div class="mt-4">
        <button type="submit" class="btn btn-primary rounded-pill">Soruyu Kaydet</button>
        <a href="{{ url_for('edit_survey', survey_id=survey.id) }}" class="btn btn-light rounded-pill ml-2">Anketi Düzenle</a>
        <a href="{{ url_for('list_surveys') }}" class="btn btn-light rounded-pill ml-2">Anket Listesine Dön</a>
      </div>
    </form>
  </div>

  <br><hr><br>

  <!-- Mevcut sorular -->
  <h5 class="mb-3">Mevcut Sorular</h5>

  {% if questions %}
    {% for q in questions %}
      <div class="card card-question mb-2">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="question-header d-flex align-items-center mb-2">
              <span class="question-number">{{ loop.index }}</span>
              <div class="ml-2">
                <strong>{{ q.question_text }}</strong>
                <div class="text-muted-sm mt-1">
                  {% if q.question_type == "single_choice" %} Tip: Tek Seçim
                  {% elif q.question_type == "multiple_choice" %} Tip: Çok Seçim
                  {% elif q.question_type == "text" %} Tip: Açık Uçlu
                  {% elif q.question_type == "rating" %} Tip: Ölçek
                  {% else %} Tip: -
                  {% endif %}
                  · Zorunlu: {{ "Evet" if q.is_required else "Hayır" }}
                </div>
              </div>
            </div>

            {% if q.question_type in ["single_choice", "multiple_choice"] %}
              <ul class="option-list mb-0 mt-2">
                {% for o in q.options %}
                  <li>
                    <span class="option-letter">{{ ('abcdefghijklmnopqrstuvwxyz')[loop.index0] }}</span>
                    {{ o.option_text }}
                  </li>
                {% endfor %}
              </ul>

            {% elif q.question_type == "text" %}
              <div class="text-muted-sm mt-2">Kullanıcı metin yazar.</div>

            {% elif q.question_type == "rating" %}
              {% if q.options and q.options|length > 0 %}
                <div class="text-muted-sm mt-2 mb-1">Ölçek seviyeleri:</div>
                <ul class="option-list mb-0 mt-2">
                  {% for o in q.options %}
                    <li>
                      <span class="option-letter">{{ loop.index }}</span>
                      {{ o.option_text }}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <div class="text-muted-sm mt-2">Ölçek sorusu (seviye tanımı bulunamadı).</div>
              {% endif %}
            {% endif %}
          </div>

          <div class="ml-3">
            <form method="post"
                  action="{{ url_for('delete_question', survey_id=survey.id, question_id=q.id) }}"
                  onsubmit="return confirm('Bu soruyu silmek istediğine emin misin?');">
              <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill">Soruyu Sil</button>
            </form>
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p class="text-muted-sm">Bu ankete henüz soru eklenmemiş.</p>
  {% endif %}
</div>

<script>
(function () {
  const questionTypeEl = document.getElementById("questionType");
  const optionsSection = document.getElementById("optionsSection");
  const textSection = document.getElementById("textSection");
  const ratingSection = document.getElementById("ratingSection");
  const optionsList = document.getElementById("optionsList");
  const addOptionBtn = document.getElementById("addOptionBtn");

  function createOptionInput(value = "") {
    const wrapper = document.createElement("div");
    wrapper.className = "form-row align-items-center mb-2";
    wrapper.innerHTML = `
      <div class="form-group col-md-10 mb-0">
        <input type="text" name="options[]" class="form-control" placeholder="Şık yaz..." value="${String(value).replace(/"/g, '&quot;')}">
      </div>
      <div class="form-group col-md-2 mb-0 text-right">
        <button type="button" class="btn btn-sm btn-outline-danger rounded-pill removeOptionBtn">Sil</button>
      </div>
    `;
    wrapper.querySelector(".removeOptionBtn").addEventListener("click", function () {
      wrapper.remove();
    });
    return wrapper;
  }

  function ensureMinOptions() {
    if (optionsList.children.length < 2) {
      while (optionsList.children.length < 2) {
        optionsList.appendChild(createOptionInput(""));
      }
    }
  }

  function updateUI() {
    const t = questionTypeEl.value;
    const isChoice = (t === "single_choice" || t === "multiple_choice");

    optionsSection.style.display = isChoice ? "block" : "none";
    textSection.style.display = (t === "text") ? "block" : "none";
    ratingSection.style.display = (t === "rating") ? "block" : "none";

    if (isChoice) ensureMinOptions();
  }

  addOptionBtn.addEventListener("click", function () {
    optionsList.appendChild(createOptionInput(""));
  });

  questionTypeEl.addEventListener("change", updateUI);

  // ilk yükleme: 2 şıkla başlasın
  optionsList.appendChild(createOptionInput(""));
  optionsList.appendChild(createOptionInput(""));
  updateUI();
})();
</script>
{% endblock %}
